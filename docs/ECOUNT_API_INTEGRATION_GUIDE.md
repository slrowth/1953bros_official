# 이카운트 ERP API 연동 가이드

## 📋 목차
1. [개요](#개요)
2. [사전 준비](#사전-준비)
3. [API 키 관리](#api-키-관리)
4. [인증 프로세스](#인증-프로세스)
5. [주문 전송 프로세스](#주문-전송-프로세스)
6. [검증 요청 프로세스](#검증-요청-프로세스)
7. [필수 필드 및 데이터 매핑](#필수-필드-및-데이터-매핑)
8. [에러 처리 및 디버깅](#에러-처리-및-디버깅)
9. [주의사항](#주의사항)

---

## 개요

이 문서는 이카운트 ERP 시스템과의 API 연동을 위한 종합 가이드입니다. 테스트 인증키부터 운영 인증키 발급, 실제 주문 전송까지의 전체 프로세스를 다룹니다.

### 주요 기능
- 이카운트 ERP로 주문 데이터 자동 전송
- 테스트 인증키를 통한 검증 요청
- 운영 인증키를 통한 실제 주문 처리

---

## 사전 준비

### 1. 이카운트 계정 및 권한
- 이카운트 ERP 로그인 계정
- API 인증키 발급 권한
- Self-Customizing > 정보관리 > API인증키발급 메뉴 접근 권한

### 2. 필수 정보 수집
다음 정보를 이카운트에서 확인해야 합니다:

| 항목 | 설명 | 예시 |
|------|------|------|
| **COM_CODE** | 회사 코드 | `667992` (6자리) |
| **USER_ID** | API 인증키를 발급받은 이카운트 로그인 ID | `홍희정` (최대 30자) |
| **ZONE** | 이카운트 도메인 ZONE | `CB`, `C`, `B`, `D` 등 (2자리) |
| **API_CERT_KEY** | 테스트/운영 인증키 | 이카운트에서 발급받은 키 (최대 50자) |

### 3. 데이터베이스 준비
- Products 테이블에 `sku` 필드가 이카운트 ERP의 품목 코드와 일치해야 함
- Stores 테이블에 `code` 필드가 이카운트 ERP의 거래처 코드와 일치해야 함

---

## API 키 관리

### 관리자 페이지 접근
- 경로: `/admin/integrations/api-keys`
- 권한: ADMIN 역할 필요

### API 키 등록
1. **라벨**: API 키를 구분하기 위한 이름 (예: "기본 ERP 키")
2. **ZONE**: 이카운트 도메인 ZONE (2자리, 예: `CB`)
3. **USER_ID**: API 인증키를 발급받은 이카운트 로그인 ID (최대 30자)
4. **API_CERT_KEY**: 이카운트에서 발급받은 인증키 (최대 50자)
5. **COM_CODE**: 이카운트 회사 코드 (정확히 6자리)

### 테스트 인증키 vs 운영 인증키

#### 테스트 인증키
- **용도**: 개발/테스트 및 검증 요청
- **특징**: 
  - 실제 주문 처리는 불가능
  - 로그인 시 `Code: "204"` 응답
  - `sboapi{ZONE}` 도메인 사용
- **발급 방법**: 이카운트 ERP > Self-Customizing > 정보관리 > API인증키발급 > 테스트 인증키

#### 운영 인증키
- **용도**: 실제 운영 환경에서 주문 처리
- **특징**:
  - 실제 주문 처리 가능
  - 로그인 시 `Code: "00"` 응답
  - `oapi{ZONE}` 도메인 사용
- **발급 방법**: 
  1. 테스트 인증키로 검증 요청 전송
  2. 이카운트 담당자가 검증 완료
  3. 이카운트 ERP > API인증키발급 > [키발급] 클릭
  4. 발급받은 운영 인증키를 시스템에 등록

---

## 인증 프로세스

### 로그인 API 호출

#### 엔드포인트
- **테스트**: `https://sboapi{ZONE}.ecount.com/OAPI/V2/OAPILogin`
- **운영**: `https://oapi{ZONE}.ecount.com/OAPI/V2/OAPILogin`

#### 요청 형식
```json
{
  "COM_CODE": "667992",
  "USER_ID": "홍희정",
  "API_CERT_KEY": "{인증키}",
  "LAN_TYPE": "ko-KR",
  "ZONE": "CB"
}
```

#### 성공 응답
```json
{
  "Status": 200,
  "Data": {
    "Code": "00",
    "Datas": {
      "SESSION_ID": "3636373939327c256564253939253864256564253964256163256563256130253935:CB-ESvJM1g1LXxBC",
      "COM_CODE": "667992",
      "USER_ID": "홍희정"
    }
  }
}
```

#### 실패 응답 (테스트 인증키)
```json
{
  "Status": 200,
  "Data": {
    "Code": "204",
    "Message": "테스트용 인증키입니다."
  }
}
```

### 중요 사항
- **도메인 일치**: 로그인 API와 주문 API는 반드시 동일한 도메인(`oapi` 또는 `sboapi`)을 사용해야 함
- **SESSION_ID**: 로그인 성공 시 받은 `SESSION_ID`를 주문 API 호출에 사용
- **세션 만료**: SESSION_ID는 일정 시간 후 만료되므로, 필요시 재로그인 필요

---

## 주문 전송 프로세스

### 엔드포인트
- **테스트**: `https://sboapi{ZONE}.ecount.com/OAPI/V2/SaleOrder/SaveSaleOrder?SESSION_ID={SESSION_ID}`
- **운영**: `https://oapi{ZONE}.ecount.com/OAPI/V2/SaleOrder/SaveSaleOrder?SESSION_ID={SESSION_ID}`

### 요청 형식
```json
{
  "SaleOrderList": [
    {
      "BulkDatas": {
        "IO_DATE": "20251118",
        "UPLOAD_SER_NO": "",
        "CUST": "00016",
        "CUST_DES": "(주)동희산업",
        "WH_CD": "00001",
        "PROD_CD": "00001",
        "PROD_DES": "test",
        "QTY": "1",
        "PRICE": "1000",
        "REMARKS": "Order# {주문ID}"
      }
    }
  ]
}
```

### 자동 전송 시점
- 사용자가 주문을 제출하면 자동으로 이카운트 ERP로 전송
- 주문 생성 API(`POST /api/orders`)에서 비동기로 처리
- ERP 전송 실패해도 주문 생성에는 영향 없음

---

## 검증 요청 프로세스

### 목적
테스트 인증키로 이카운트에 검증 요청을 전송하여, 운영 인증키 발급을 받기 위한 프로세스

### 절차
1. **관리자 페이지 접근**: `/admin/integrations/api-keys`
2. **검증 요청 버튼 클릭**: 등록된 API 키의 "검증 요청" 버튼 클릭
3. **자동 처리**:
   - 테스트 인증키로 로그인 (`sboapi` 도메인 사용)
   - SESSION_ID 획득
   - 검증용 테스트 주문 데이터 전송
4. **이카운트 확인**: 이카운트 담당자가 검증 요청 확인
5. **운영 인증키 발급**: 이카운트 ERP에서 운영 인증키 발급 후 시스템에 등록

### 검증용 테스트 데이터
- **WH_CD**: `"00001"` (출하창고 코드, 통일)
- **PROD_CD**: Products 테이블의 실제 `sku` 값 사용
- **CUST**: `"00001"` (테스트 거래처)
- **QTY**: `"1"`
- **PRICE**: `"1000"`

### SESSION_ID 직접 입력
- 테스트 인증키 응답에 SESSION_ID가 없는 경우
- 사용자가 직접 SESSION_ID를 입력할 수 있는 모달 표시
- 입력한 SESSION_ID로 검증 요청 전송

---

## 필수 필드 및 데이터 매핑

### 로그인 API 필수 필드

| 필드명 | 설명 | 자릿수 | 예시 |
|--------|------|--------|------|
| COM_CODE | 회사 코드 | 6자리 | `667992` |
| USER_ID | 사용자 ID | 최대 30자 | `홍희정` |
| API_CERT_KEY | 인증키 | 최대 50자 | 이카운트에서 발급 |
| LAN_TYPE | 언어 설정 | - | `ko-KR` |
| ZONE | ZONE | 2자리 | `CB` |

### 주문 API 필수 필드

| 필드명 | 설명 | 데이터 소스 | 예시 |
|--------|------|-------------|------|
| **WH_CD** | 출하창고 코드 | 고정값 | `"00001"` |
| **PROD_CD** | 품목 코드 | Products 테이블의 `sku` | `"00001"` |
| IO_DATE | 주문일자 | 주문 생성일 또는 현재일 | `"20251118"` |
| CUST | 거래처 코드 | Stores 테이블의 `code` | `"00016"` |
| CUST_DES | 거래처명 | Stores 테이블의 `name` | `"(주)동희산업"` |
| QTY | 수량 | 주문 품목의 `quantity` | `"1"` |
| PRICE | 단가 | 주문 품목의 `unit_price` | `"1000"` |

### 데이터 매핑 규칙

#### Products 테이블
- `products.sku` → `PROD_CD` (이카운트 ERP의 품목 코드와 일치해야 함)
- `products.name` → `PROD_DES`

#### Stores 테이블
- `stores.code` → `CUST` (이카운트 ERP의 거래처 코드와 일치해야 함)
- `stores.name` → `CUST_DES`

#### Orders 테이블
- `orders.placed_at` → `IO_DATE` (YYYYMMDD 형식)
- `orders.id` → `REMARKS` (주문 추적용)

---

## 에러 처리 및 디버깅

### 주요 에러 코드 및 해결 방법

#### 1. 로그인 실패

**에러**: `Code: "10"` 또는 `Code: "20"`  
**메시지**: "올바른 회사코드/아이디/비밀번호를 입력해주세요."

**원인**:
- COM_CODE, USER_ID, API_CERT_KEY 중 하나 이상이 잘못됨
- ZONE이 잘못됨

**해결 방법**:
1. 이카운트 ERP에서 정확한 값 확인
2. API 키 관리 페이지에서 값 재입력
3. ZONE이 정확한지 확인 (대소문자 구분)

---

#### 2. 테스트 인증키 오류

**에러**: `Code: "204"`  
**메시지**: "테스트용 인증키입니다."

**원인**:
- 테스트 인증키로 실제 주문 처리를 시도함

**해결 방법**:
- 검증 요청은 `sboapi` 도메인 사용
- 실제 주문 처리를 위해서는 운영 인증키 필요

---

#### 3. 도메인 불일치 오류

**에러**: `Code: "EXP00001"`  
**메시지**: "로그인 API와 입/출력 API의 요청 URL(https://oapi, sboapi)이 일치하지 않습니다."

**원인**:
- 로그인 API와 주문 API가 서로 다른 도메인 사용
- 예: 로그인은 `oapi`, 주문은 `sboapi` 사용

**해결 방법**:
- 테스트 인증키: 모두 `sboapi{ZONE}` 사용
- 운영 인증키: 모두 `oapi{ZONE}` 사용
- 동일한 도메인으로 통일

---

#### 4. 세션 만료 오류

**에러**: `Code: "EXP00001"`  
**메시지**: "Please login."

**원인**:
- SESSION_ID가 만료됨
- 다른 도메인에서 발급받은 SESSION_ID 사용

**해결 방법**:
- 로그인 API를 다시 호출하여 새로운 SESSION_ID 획득
- 동일한 도메인에서 발급받은 SESSION_ID 사용

---

#### 5. 필수 필드 누락

**에러**: `FailCnt > 0`  
**메시지**: "출하창고(필수)", "품목코드(미등록코드[...])"

**원인**:
- `WH_CD` 또는 `PROD_CD`가 누락되거나 잘못됨
- 이카운트 ERP에 등록되지 않은 코드 사용

**해결 방법**:
- `WH_CD`는 `"00001"`로 통일
- `PROD_CD`는 이카운트 ERP에 등록된 품목 코드 사용
- Products 테이블의 `sku`가 이카운트 ERP의 품목 코드와 일치하는지 확인

---

### 로깅 및 디버깅

#### 서버 로그 확인
- Vercel 배포 환경: Vercel 대시보드 > Functions > Logs
- 로컬 환경: 터미널에서 `[ECOUNT]`로 시작하는 로그 확인

#### 주요 로그 키워드
- `[ECOUNT] ✅`: 성공 로그
- `[ECOUNT] ❌`: 실패 로그
- `[ECOUNT] ⚠️`: 경고 로그
- `[ECOUNT] 💡`: 정보 로그

#### 디버깅 체크리스트
1. ✅ API 키가 올바르게 등록되었는지 확인
2. ✅ ZONE이 정확한지 확인 (2자리)
3. ✅ COM_CODE가 정확한지 확인 (6자리)
4. ✅ 로그인 API와 주문 API가 동일한 도메인 사용하는지 확인
5. ✅ Products 테이블의 `sku`가 이카운트 ERP에 등록되어 있는지 확인
6. ✅ Stores 테이블의 `code`가 이카운트 ERP에 등록되어 있는지 확인

---

## 주의사항

### 1. 도메인 일치 필수
- **절대 금지**: 로그인은 `oapi`, 주문은 `sboapi` 사용
- **테스트**: 모두 `sboapi{ZONE}` 사용
- **운영**: 모두 `oapi{ZONE}` 사용

### 2. 데이터 동기화
- Products 테이블의 `sku`는 이카운트 ERP의 품목 코드와 일치해야 함
- Stores 테이블의 `code`는 이카운트 ERP의 거래처 코드와 일치해야 함
- 데이터 불일치 시 주문 전송 실패

### 3. 인증키 관리
- 테스트 인증키와 운영 인증키를 구분하여 관리
- 운영 인증키는 보안에 주의 (환경 변수 또는 암호화 저장 권장)
- 인증키 변경 시 기존 주문 처리에 영향 없음 (새 인증키로 재로그인)

### 4. 에러 처리
- ERP 전송 실패해도 주문 생성에는 영향 없음 (비동기 처리)
- 실패 시 로그에 상세 정보 기록
- 사용자에게는 일반적인 에러 메시지만 표시

### 5. 검증 요청
- 검증 요청은 테스트 인증키로만 가능
- 검증 완료 후 운영 인증키 발급 필요
- 검증 요청 시 실제 ERP에 등록된 품목 코드 사용 권장

---

## 파일 구조

### 주요 파일
```
src/
├── lib/
│   └── integrations/
│       └── ecount.js                    # 이카운트 API 연동 로직
├── app/
│   ├── api/
│   │   ├── orders/
│   │   │   └── route.js                 # 주문 생성 API (ERP 전송 호출)
│   │   └── integrations/
│   │       └── ecount/
│   │           ├── keys/
│   │           │   └── route.js          # API 키 관리 API
│   │           ├── keys/[id]/
│   │           │   └── route.js          # API 키 삭제 API
│   │           └── verify/
│   │               └── route.js          # 검증 요청 API
│   └── admin/
│       └── integrations/
│           └── api-keys/
│               └── page.jsx             # API 키 관리 페이지
```

### 데이터베이스 테이블
```sql
-- API 키 저장
integration_keys (
  id, service, label, zone, api_key, 
  session_id, config (JSONB: com_code), 
  created_by, created_at
)

-- 주문 데이터
orders (
  id, store_id, status, total_amount, ...
)

-- 주문 품목
order_items (
  id, order_id, product_id, quantity, unit_price, ...
)

-- 상품 (sku가 이카운트 품목 코드와 일치)
products (
  id, name, sku, price, ...
)

-- 매장 (code가 이카운트 거래처 코드와 일치)
stores (
  id, name, code, ...
)
```

---

## 체크리스트

### 초기 설정
- [ ] 이카운트 ERP 계정 및 권한 확인
- [ ] COM_CODE, USER_ID, ZONE 정보 수집
- [ ] 테스트 인증키 발급
- [ ] API 키 관리 페이지에서 키 등록
- [ ] Products 테이블의 `sku`가 이카운트 품목 코드와 일치하는지 확인
- [ ] Stores 테이블의 `code`가 이카운트 거래처 코드와 일치하는지 확인

### 검증 요청
- [ ] 테스트 인증키로 검증 요청 전송
- [ ] 이카운트 담당자에게 검증 요청 확인 요청
- [ ] 운영 인증키 발급 대기
- [ ] 운영 인증키를 시스템에 등록

### 운영 전환
- [ ] 운영 인증키로 로그인 테스트
- [ ] 실제 주문 전송 테스트
- [ ] 에러 로그 모니터링
- [ ] 주문 전송 성공률 확인

---

## 참고 자료

### 이카운트 API 문서
- 로그인 API: `/OAPI/V2/OAPILogin`
- 주문서입력 API: `/OAPI/V2/SaleOrder/SaveSaleOrder`
- 이카운트 ERP > Self-Customizing > 정보관리 > API인증키발급

### 관련 문서
- 이카운트 오픈 API 이용 방법
- 이카운트 API 인증키 발급 가이드

---

## 문의 및 지원

### 이카운트 지원
- 이카운트 고객센터
- 이카운트 API 담당자

### 내부 지원
- 개발팀: API 연동 관련 기술 문의
- 운영팀: ERP 데이터 동기화 문의

---

**마지막 업데이트**: 2025-11-18  
**작성자**: 개발팀  
**버전**: 1.0

